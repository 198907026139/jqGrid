(function(b){"function"===typeof define&&define.amd?define(["jquery","./grid.base"],b):b(jQuery)})(function(b){b.jgrid.extend({editCell:function(d,e,a){return this.each(function(){var c=this,h,f,i,g,j=b(this).jqGrid("getStyleUI",c.p.styleUI+".common","highlight",!0),k=b(this).jqGrid("getStyleUI",c.p.styleUI+".common","hover",!0),m=b(this).jqGrid("getStyleUI",c.p.styleUI+".celledit","inputClass",!0);if(c.grid&&!0===c.p.cellEdit){e=parseInt(e,10);c.p.selrow=c.rows[d].id;c.p.knv||b(c).jqGrid("GridNav");
if(0<c.p.savedRow.length){if(!0===a&&d==c.p.iRow&&e==c.p.iCol)return;b(c).jqGrid("saveCell",c.p.savedRow[0].id,c.p.savedRow[0].ic)}else window.setTimeout(function(){b("#"+b.jgrid.jqID(c.p.knv)).attr("tabindex","-1").focus()},1);g=c.p.colModel[e];h=g.name;if(!("subgrid"===h||"cb"===h||"rn"===h)){i=b("td:eq("+e+")",c.rows[d]);if(!0===g.editable&&!0===a&&!i.hasClass("not-editable-cell")&&(!b.isFunction(c.p.isCellEditable)||c.p.isCellEditable.call(c,h,d,e))){0<=parseInt(c.p.iCol,10)&&0<=parseInt(c.p.iRow,
10)&&b(c.rows[c.p.iRow]).removeClass("selected-row "+k).find("td:eq("+c.p.iCol+")").removeClass("edit-cell "+j);b(i).addClass("edit-cell "+j);b(c.rows[d]).addClass("selected-row "+k);try{f=b.unformat.call(c,i,{rowId:c.rows[d].id,colModel:g},e)}catch(l){f=g.edittype&&"textarea"===g.edittype?b(i).text():b(i).html()}c.p.autoencode&&(f=b.jgrid.htmlDecode(f));g.edittype||(g.edittype="text");c.p.savedRow.push({id:d,ic:e,name:h,v:f});if("&nbsp;"===f||"&#160;"===f||1===f.length&&160===f.charCodeAt(0))f="";
b.isFunction(c.p.formatCell)&&(j=c.p.formatCell.call(c,c.rows[d].id,h,f,d,e),void 0!==j&&(f=j));b(c).triggerHandler("jqGridBeforeEditCell",[c.rows[d].id,h,f,d,e]);b.isFunction(c.p.beforeEditCell)&&c.p.beforeEditCell.call(c,c.rows[d].id,h,f,d,e);var j=b.extend({},g.editoptions||{},{id:d+"_"+h,name:h,rowId:c.rows[d].id,oper:"edit"}),n=b.jgrid.createEl.call(c,g.edittype,j,f,!0,b.extend({},b.jgrid.ajaxOptions,c.p.ajaxSelectOptions||{}));-1<b.inArray(g.edittype,["text","textarea","password","select"])&&
b(n).addClass(m);b(i).html("").append(n).attr("tabindex","0");b.jgrid.bindEv.call(c,n,j);window.setTimeout(function(){b(n).focus()},1);b("input, select, textarea",i).bind("keydown",function(a){a.keyCode===27&&(b("input.hasDatepicker",i).length>0?b(".ui-datepicker").is(":hidden")?b(c).jqGrid("restoreCell",d,e):b("input.hasDatepicker",i).datepicker("hide"):b(c).jqGrid("restoreCell",d,e));if(a.keyCode===13&&!a.shiftKey){b(c).jqGrid("saveCell",d,e);return false}if(a.keyCode===9){if(c.grid.hDiv.loading)return false;
a.shiftKey?b(c).jqGrid("prevCell",d,e):b(c).jqGrid("nextCell",d,e)}a.stopPropagation()});b(c).triggerHandler("jqGridAfterEditCell",[c.rows[d].id,h,f,d,e]);b.isFunction(c.p.afterEditCell)&&c.p.afterEditCell.call(c,c.rows[d].id,h,f,d,e)}else 0<=parseInt(c.p.iCol,10)&&0<=parseInt(c.p.iRow,10)&&b(c.rows[c.p.iRow]).removeClass("selected-row "+k).find("td:eq("+c.p.iCol+")").removeClass("edit-cell "+j),i.addClass("edit-cell "+j),b(c.rows[d]).addClass("selected-row "+k),f=i.html().replace(/\&#160\;/ig,""),
b(c).triggerHandler("jqGridSelectCell",[c.rows[d].id,h,f,d,e]),b.isFunction(c.p.onSelectCell)&&c.p.onSelectCell.call(c,c.rows[d].id,h,f,d,e);c.p.iCol=e;c.p.iRow=d}}})},saveCell:function(d,e){return this.each(function(){var a=this,c,h=b.jgrid.getRegional(this,"errors"),f=b.jgrid.getRegional(this,"edit");if(a.grid&&!0===a.p.cellEdit){c=1<=a.p.savedRow.length?0:null;if(null!==c){var i=b("td:eq("+e+")",a.rows[d]),g,j,k=a.p.colModel[e],m=k.name,l=b.jgrid.jqID(m);switch(k.edittype){case "select":if(k.editoptions.multiple){var l=
b("#"+d+"_"+l,a.rows[d]),n=[];(g=b(l).val())?g.join(","):g="";b("option:selected",l).each(function(a,c){n[a]=b(c).text()});j=n.join(",")}else g=b("#"+d+"_"+l+" option:selected",a.rows[d]).val(),j=b("#"+d+"_"+l+" option:selected",a.rows[d]).text();k.formatter&&(j=g);break;case "checkbox":var p=["Yes","No"];k.editoptions&&(p=k.editoptions.value.split(":"));j=g=b("#"+d+"_"+l,a.rows[d]).is(":checked")?p[0]:p[1];break;case "password":case "text":case "textarea":case "button":j=g=b("#"+d+"_"+l,a.rows[d]).val();
break;case "custom":try{if(k.editoptions&&b.isFunction(k.editoptions.custom_value)){g=k.editoptions.custom_value.call(a,b(".customelement",i),"get");if(void 0===g)throw"e2";j=g}else throw"e1";}catch(q){"e1"===q?b.jgrid.info_dialog(h.errcap,"function 'custom_value' "+f.msg.nodefined,f.bClose,{styleUI:a.p.styleUI}):"e2"===q?b.jgrid.info_dialog(h.errcap,"function 'custom_value' "+f.msg.novalue,f.bClose,{styleUI:a.p.styleUI}):b.jgrid.info_dialog(h.errcap,q.message,f.bClose,{styleUI:a.p.styleUI})}}if(j!==
a.p.savedRow[c].v){if(c=b(a).triggerHandler("jqGridBeforeSaveCell",[a.rows[d].id,m,g,d,e]))j=g=c;if(b.isFunction(a.p.beforeSaveCell)&&(c=a.p.beforeSaveCell.call(a,a.rows[d].id,m,g,d,e)))j=g=c;var r=b.jgrid.checkValues.call(a,g,e);if(!0===r[0]){c=b(a).triggerHandler("jqGridBeforeSubmitCell",[a.rows[d].id,m,g,d,e])||{};b.isFunction(a.p.beforeSubmitCell)&&((c=a.p.beforeSubmitCell.call(a,a.rows[d].id,m,g,d,e))||(c={}));0<b("input.hasDatepicker",i).length&&b("input.hasDatepicker",i).datepicker("hide");
if("remote"===a.p.cellsubmit)if(a.p.cellurl){var o={};a.p.autoencode&&(g=b.jgrid.htmlEncode(g));o[m]=g;p=a.p.prmNames;k=p.id;l=p.oper;o[k]=b.jgrid.stripPref(a.p.idPrefix,a.rows[d].id);o[l]=p.editoper;o=b.extend(c,o);b(a).jqGrid("progressBar",{method:"show",loadtype:a.p.loadui,htmlcontent:b.jgrid.getRegional(a,"defaults.savetext")});a.grid.hDiv.loading=!0;b.ajax(b.extend({url:a.p.cellurl,data:b.isFunction(a.p.serializeCellData)?a.p.serializeCellData.call(a,o):o,type:"POST",complete:function(c,k){b(a).jqGrid("progressBar",
{method:"hide",loadtype:a.p.loadui});a.grid.hDiv.loading=false;if(k==="success"){var l=b(a).triggerHandler("jqGridAfterSubmitCell",[a,c,o.id,m,g,d,e])||[true,""];l[0]===true&&b.isFunction(a.p.afterSubmitCell)&&(l=a.p.afterSubmitCell.call(a,c,o.id,m,g,d,e));if(l[0]===true){b(i).empty();b(a).jqGrid("setCell",a.rows[d].id,e,j,false,false,true);b(i).addClass("dirty-cell");b(a.rows[d]).addClass("edited");b(a).triggerHandler("jqGridAfterSaveCell",[a.rows[d].id,m,g,d,e]);b.isFunction(a.p.afterSaveCell)&&
a.p.afterSaveCell.call(a,a.rows[d].id,m,g,d,e);a.p.savedRow.splice(0,1)}else{b.jgrid.info_dialog(h.errcap,l[1],f.bClose,{styleUI:a.p.styleUI});a.p.restoreCellonFail&&b(a).jqGrid("restoreCell",d,e)}}},error:function(c,g,i){b("#lui_"+b.jgrid.jqID(a.p.id)).hide();a.grid.hDiv.loading=false;b(a).triggerHandler("jqGridErrorCell",[c,g,i]);b.isFunction(a.p.errorCell)?a.p.errorCell.call(a,c,g,i):b.jgrid.info_dialog(h.errcap,c.status+" : "+c.statusText+"<br/>"+g,f.bClose,{styleUI:a.p.styleUI});a.p.restoreCellonFail&&
b(a).jqGrid("restoreCell",d,e)}},b.jgrid.ajaxOptions,a.p.ajaxCellOptions||{}))}else try{b.jgrid.info_dialog(h.errcap,h.nourl,f.bClose,{styleUI:a.p.styleUI}),a.p.restoreCellonFail&&b(a).jqGrid("restoreCell",d,e)}catch(s){}"clientArray"===a.p.cellsubmit&&(b(i).empty(),b(a).jqGrid("setCell",a.rows[d].id,e,j,!1,!1,!0),b(i).addClass("dirty-cell"),b(a.rows[d]).addClass("edited"),b(a).triggerHandler("jqGridAfterSaveCell",[a.rows[d].id,m,g,d,e]),b.isFunction(a.p.afterSaveCell)&&a.p.afterSaveCell.call(a,a.rows[d].id,
m,g,d,e),a.p.savedRow.splice(0,1))}else try{window.setTimeout(function(){b.jgrid.info_dialog(h.errcap,g+" "+r[1],f.bClose,{styleUI:a.p.styleUI})},100),b(a).jqGrid("restoreCell",d,e)}catch(t){}}else b(a).jqGrid("restoreCell",d,e)}window.setTimeout(function(){b("#"+b.jgrid.jqID(a.p.knv)).attr("tabindex","-1").focus()},0)}})},restoreCell:function(d,e){return this.each(function(){var a=this,c;if(a.grid&&!0===a.p.cellEdit){c=1<=a.p.savedRow.length?0:null;if(null!==c){var h=b("td:eq("+e+")",a.rows[d]);
if(b.isFunction(b.fn.datepicker))try{b("input.hasDatepicker",h).datepicker("hide")}catch(f){}b(h).empty().attr("tabindex","-1");b(a).jqGrid("setCell",a.rows[d].id,e,a.p.savedRow[c].v,!1,!1,!0);b(a).triggerHandler("jqGridAfterRestoreCell",[a.rows[d].id,a.p.savedRow[c].v,d,e]);b.isFunction(a.p.afterRestoreCell)&&a.p.afterRestoreCell.call(a,a.rows[d].id,a.p.savedRow[c].v,d,e);a.p.savedRow.splice(0,1)}window.setTimeout(function(){b("#"+a.p.knv).attr("tabindex","-1").focus()},0)}})},nextCell:function(d,
e){return this.each(function(){var a=!1,c;if(this.grid&&!0===this.p.cellEdit){for(c=e+1;c<this.p.colModel.length;c++)if(!0===this.p.colModel[c].editable&&(!b.isFunction(this.p.isCellEditable)||this.p.isCellEditable.call(this,this.p.colModel[c].name,d,c))){a=c;break}!1!==a?b(this).jqGrid("editCell",d,a,!0):0<this.p.savedRow.length&&b(this).jqGrid("saveCell",d,e)}})},prevCell:function(d,e){return this.each(function(){var a=!1,c;if(this.grid&&!0===this.p.cellEdit){for(c=e-1;0<=c;c--)if(!0===this.p.colModel[c].editable&&
(!b.isFunction(this.p.isCellEditable)||this.p.isCellEditable.call(this,this.p.colModel[c].name,d,c))){a=c;break}!1!==a?b(this).jqGrid("editCell",d,a,!0):0<this.p.savedRow.length&&b(this).jqGrid("saveCell",d,e)}})},GridNav:function(){return this.each(function(){function d(c,d,e){if("v"===e.substr(0,1)){var f=b(a.grid.bDiv)[0].clientHeight,h=b(a.grid.bDiv)[0].scrollTop,l=a.rows[c].offsetTop+a.rows[c].clientHeight,n=a.rows[c].offsetTop;"vd"===e&&l>=f&&(b(a.grid.bDiv)[0].scrollTop=b(a.grid.bDiv)[0].scrollTop+
a.rows[c].clientHeight);"vu"===e&&n<h&&(b(a.grid.bDiv)[0].scrollTop=b(a.grid.bDiv)[0].scrollTop-a.rows[c].clientHeight)}"h"===e&&(e=b(a.grid.bDiv)[0].clientWidth,f=b(a.grid.bDiv)[0].scrollLeft,h=a.rows[c].cells[d].offsetLeft,a.rows[c].cells[d].offsetLeft+a.rows[c].cells[d].clientWidth>=e+parseInt(f,10)?b(a.grid.bDiv)[0].scrollLeft=b(a.grid.bDiv)[0].scrollLeft+a.rows[c].cells[d].clientWidth:h<f&&(b(a.grid.bDiv)[0].scrollLeft=b(a.grid.bDiv)[0].scrollLeft-a.rows[c].cells[d].clientWidth))}function e(b,
c){var d,e;if("lft"===c){d=b+1;for(e=b;0<=e;e--)if(!0!==a.p.colModel[e].hidden){d=e;break}}if("rgt"===c){d=b-1;for(e=b;e<a.p.colModel.length;e++)if(!0!==a.p.colModel[e].hidden){d=e;break}}return d}var a=this;if(a.grid&&!0===a.p.cellEdit){a.p.knv=a.p.id+"_kn";var c=b("<div style='position:fixed;top:0px;width:1px;height:1px;' tabindex='0'><div tabindex='-1' style='width:1px;height:1px;' id='"+a.p.knv+"'></div></div>"),h,f;b(c).insertBefore(a.grid.cDiv);b("#"+a.p.knv).focus().keydown(function(c){f=c.keyCode;
"rtl"===a.p.direction&&(37===f?f=39:39===f&&(f=37));switch(f){case 38:0<a.p.iRow-1&&(d(a.p.iRow-1,a.p.iCol,"vu"),b(a).jqGrid("editCell",a.p.iRow-1,a.p.iCol,!1));break;case 40:a.p.iRow+1<=a.rows.length-1&&(d(a.p.iRow+1,a.p.iCol,"vd"),b(a).jqGrid("editCell",a.p.iRow+1,a.p.iCol,!1));break;case 37:0<=a.p.iCol-1&&(h=e(a.p.iCol-1,"lft"),d(a.p.iRow,h,"h"),b(a).jqGrid("editCell",a.p.iRow,h,!1));break;case 39:a.p.iCol+1<=a.p.colModel.length-1&&(h=e(a.p.iCol+1,"rgt"),d(a.p.iRow,h,"h"),b(a).jqGrid("editCell",
a.p.iRow,h,!1));break;case 13:0<=parseInt(a.p.iCol,10)&&0<=parseInt(a.p.iRow,10)&&b(a).jqGrid("editCell",a.p.iRow,a.p.iCol,!0);break;default:return!0}return!1})}})},getChangedCells:function(d){var e=[];d||(d="all");this.each(function(){var a=this,c;a.grid&&!0===a.p.cellEdit&&b(a.rows).each(function(h){var f={};b(this).hasClass("edited")&&(b("td",this).each(function(e){c=a.p.colModel[e].name;if("cb"!==c&&"subgrid"!==c)if("dirty"===d){if(b(this).hasClass("dirty-cell"))try{f[c]=b.unformat.call(a,this,
{rowId:a.rows[h].id,colModel:a.p.colModel[e]},e)}catch(g){f[c]=b.jgrid.htmlDecode(b(this).html())}}else try{f[c]=b.unformat.call(a,this,{rowId:a.rows[h].id,colModel:a.p.colModel[e]},e)}catch(j){f[c]=b.jgrid.htmlDecode(b(this).html())}}),f.id=this.id,e.push(f))})});return e}})});
